<ng-container *ngIf="(pedido$ | async) as pedido; else loadingOrError">

  <div class="page-container" id="printable-area">

    <header class="page-header">
      <a routerLink="/admin/pedidos" class="back-button">
        <i class="bi bi-arrow-left"></i>
        <span>Voltar para Pedidos</span>
      </a>
      <div class="header-content">
        <h1>Pedido #{{ pedido.id.substring(0, 8) }}</h1>
        <span class="order-date">Recebido em: {{ pedido.dataCriacao | date:'dd/MM/yyyy HH:mm' }}</span>
      </div>
      <div class="header-actions">
        <a [href]="'https://wa.me/' + pedido.whatsappCliente" target="_blank" rel="noopener" class="btn btn-secondary">
          <i class="bi bi-whatsapp"></i> Falar com Cliente
        </a>
        <button class="btn btn-secondary" (click)="imprimirPedido()">
          <i class="bi bi-printer"></i> Imprimir
        </button>
      </div>
    </header>

    <main class="order-layout">
      
      <div class="main-column">

        <div class="card">
          <div class="card-header">
            <i class="bi bi-box-seam"></i>
            <h3>Itens do Pedido ({{ pedido.itens.length }})</h3>
          </div>
          <ul class="item-list">
            <li *ngFor="let item of pedido.itens" class="item-list-row">
              <div class="item-product-info">
                <span class="item-quantity">{{ item.quantidade }}x</span>
                <span class="item-name">{{ item.nomeProduto }}</span>
              </div>
              <div class="item-pricing">
                <span class="item-subtotal">{{ (item.quantidade * item.precoUnitario) | currency:'BRL' }}</span>
              </div>
            </li>
          </ul>
          <div class="card-footer order-totals">
            <div class="total-row">
              <span>Subtotal</span>
              <span>{{ pedido.subtotal | currency:'BRL' }}</span>
            </div>
            <div class="total-row" *ngIf="pedido.taxaEntrega > 0">
              <span>Taxa de Entrega</span>
              <span>{{ pedido.taxaEntrega | currency:'BRL' }}</span>
            </div>
            <div class="total-row grand-total">
              <strong>Total do Pedido</strong>
              <strong>{{ pedido.valorTotal | currency:'BRL' }}</strong>
            </div>
          </div>
        </div>
        
        <div class="card" *ngIf="pedido.metodoPagamento === 'Pix' && pedido.pixQrCodeBase64">
          <div class="card-header">
            <i class="bi bi-qr-code"></i>
            <h3>Pagamento PIX</h3>
          </div>
          <div class="pix-container">
            <div class="pix-qr-code">
               <img [src]="'data:image/jpeg;base64,' + pedido.pixQrCodeBase64" alt="PIX QR Code">
            </div>
            <div class="pix-details">
              <label for="pix-code-admin">PIX Copia e Cola:</label>
              <textarea id="pix-code-admin" class="pix-code-area" readonly>{{ pedido.pixCopiaECola }}</textarea>
               <button class="btn btn-secondary" (click)="copiarPix()">
                <i class="bi bi-clipboard-check"></i>
                Copiar Código
              </button>
            </div>
          </div>
        </div>

      </div>

      <aside class="sidebar-column">

        <div class="card">
          <div class="card-header">
            <i class="bi bi-toggles"></i>
            <h3>Gerenciar Pedido</h3>
          </div>
          <div class="card-body">
            <div class="detail-item">
              <span class="detail-label">Status Atual</span>
              <span class="status-badge" [ngClass]="pedido.status.toLowerCase()">{{ pedido.status.replace('_', ' ') }}</span>
            </div>
            <hr>
            <label for="status-select" class="detail-label">Alterar status para:</label>
            <select id="status-select" class="form-select" [(ngModel)]="statusSelecionado">
              <option *ngFor="let status of listaDeStatus" [value]="status">
                {{ status.replace('_', ' ') | titlecase }}
              </option>
            </select>
            <button class="btn btn-primary" (click)="atualizarStatus()" [disabled]="statusSelecionado === pedido.status">
              Salvar Alteração
            </button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <i class="bi bi-person-circle"></i>
            <h3>Cliente e Entrega</h3>
          </div>
          <div class="card-body">
            <div class="detail-item">
              <span class="detail-label">Nome</span>
              <strong class="detail-value">{{ pedido.nomeCliente }}</strong>
            </div>
            <div class="detail-item">
              <span class="detail-label">WhatsApp</span>
              <span class="detail-value">{{ pedido.whatsappCliente }}</span>
            </div>
             <div class="detail-item">
              <span class="detail-label">Pagamento</span>
              <span class="detail-value">{{ pedido.metodoPagamento }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Método de Entrega</span>
              <span class="detail-value">{{ pedido.metodoEntrega.replace('_', ' ') | titlecase }}</span>
            </div>
            <div class="detail-item full-width" *ngIf="pedido.metodoEntrega === 'ENTREGA_LOCAL'">
              <hr>
              <span class="detail-label">Endereço de Entrega</span>
              <address class="detail-value">
                {{ pedido.endereco }}, {{ pedido.numero }} {{ pedido.complemento ? '- ' + pedido.complemento : '' }}<br>
                {{ pedido.bairro }} - CEP: {{ pedido.cep }}
              </address>
            </div>
          </div>
        </div>

      </aside>
    </main>
  </div>

  <div class="printable-receipt">
    </div>

</ng-container>

<ng-template #loadingOrError>
  <div class="page-container state-container">
      <div *ngIf="isLoading; else notFound">
          <div class="spinner"></div>
          <p>A carregar detalhes do pedido...</p>
      </div>
      <ng-template #notFound>
          <div class="not-found-container">
              <i class="bi bi-exclamation-triangle"></i>
              <h3>Pedido não encontrado</h3>
              <p>O pedido que você procura não existe ou o ID é inválido.</p>
          </div>
      </ng-template>
  </div>
</ng-template>