<div class="form-container">
  <h3>{{ pageTitle }}</h3>

  <div *ngIf="submitErrorMessage" class="alert alert-danger">
    {{ submitErrorMessage }}
  </div>

  <form [formGroup]="productForm" (ngSubmit)="onSubmit()" novalidate>
    <div class="form-grid">
      <div class="form-column">
        <div class="form-group">
          <label for="nome">Nome do Produto</label>
          <input id="nome" type="text" formControlName="nome">
          <div *ngIf="nome?.invalid && (nome?.dirty || nome?.touched)" class="validation-error">
            <small *ngIf="nome?.errors?.['required']">Nome é obrigatório.</small>
          </div>
        </div>

        <div class="form-group">
          <label for="descricao">Descrição</label>
          <textarea id="descricao" formControlName="descricao" rows="5"></textarea>
        </div>

        <div class="form-group image-upload-group">
          <label>Imagem do Produto</label>
          <button type="button" class="btn-secondary" (click)="fileInput.click()">
            Escolher Imagem
          </button>
          <input #fileInput type="file" (change)="onFileSelected($event)" accept="image/*" style="display: none;">

          <div class="cropper-container" *ngIf="imageChangedEvent">
            <image-cropper
                [imageChangedEvent]="imageChangedEvent"
                [maintainAspectRatio]="true"
                [aspectRatio]="1 / 1"
                [resizeToWidth]="400"
                format="jpeg"
                (imageCropped)="imageCropped($event)"
            ></image-cropper>
          </div>

          <div class="image-preview" *ngIf="croppedImage">
            <p>Pré-visualização Final:</p>
            <img [src]="croppedImage" alt="Pré-visualização da Imagem Enquadrada">
          </div>
        </div>
      </div>

      <div class="form-column">
        <div class="form-group">
          <label for="preco">Preço (R$)</label>
          <input id="preco" type="number" formControlName="preco">
          </div>
        <div class="form-group">
          <label for="estoque">Estoque</label>
          <input id="estoque" type="number" formControlName="estoque">
          </div>
        <div class="form-group">
          <label for="categoria">Categoria</label>
          <select id="categoria" formControlName="categoria">
            <option [ngValue]="null" disabled>Selecione uma categoria</option>
            <option *ngFor="let cat of categorias" [ngValue]="cat.id">
              {{ cat.nome }}
            </option>
          </select>
          </div>
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" [disabled]="isLoading" class="submit-button">
        <span *ngIf="!isLoading">Salvar Alterações</span>
        <span *ngIf="isLoading" class="spinner"></span>
      </button>
    </div>
  </form>
</div>