<main class="checkout-container">
  <header class="page-header">
    <h1>Finalizar Pedido</h1>
  </header>

  <div class="checkout-layout" *ngIf="cartItems.length > 0; else emptyCart">

    <!-- Coluna Principal (Carrinho e Formulários) -->
    <div class="main-column">

      <!-- Seção 1: Revisão do Carrinho -->
      <section class="card" aria-labelledby="cart-heading">
        <header class="card-header">
          <h2 id="cart-heading"><i class="bi bi-cart-check-fill"></i> Revise o seu Carrinho</h2>
        </header>
        <div>
          <article class="cart-item" *ngFor="let item of cartItems">
            <img [src]="item.produto.urlImagem" [alt]="item.produto.nome" class="cart-item__image">
            <div class="cart-item__details">
              <p class="cart-item__name">{{ item.produto.nome }}</p>
              <p class="cart-item__price--single">{{ item.produto.preco | currency:'BRL' }}</p>
              <button class="cart-item__remove" (click)="removerItem(item)">
                <i class="bi bi-trash3"></i> Remover
              </button>
            </div>
            <div class="cart-item__quantity">
              <button class="quantity-button" (click)="decrementarQuantidade(item)" [disabled]="item.quantidade === 1" aria-label="Diminuir quantidade">-</button>
              <span class="quantity-value">{{ item.quantidade }}</span>
              <button class="quantity-button" (click)="incrementarQuantidade(item)" aria-label="Aumentar quantidade">+</button>
            </div>
            <div class="cart-item__price">
              <span>{{ (item.produto.preco * item.quantidade) | currency:'BRL' }}</span>
            </div>
          </article>
        </div>
      </section>

      <!-- Seção 2: Formulário de Dados e Entrega -->
      <section class="card" aria-labelledby="details-heading">
        <header class="card-header">
          <h2 id="details-heading"><i class="bi bi-person-lines-fill"></i> Formulário de Entrega</h2>
        </header>
        <form [formGroup]="checkoutForm" (ngSubmit)="onSubmit()" id="checkout-main-form">
          <fieldset>
            <div class="form-grid">
              <div class="form-group">
                <label for="nomeCliente">Nome Completo</label>
                <input id="nomeCliente" formControlName="nomeCliente" type="text" placeholder="Digite seu nome completo">
              </div>
              <div class="form-group">
                <label for="whatsappCliente">WhatsApp</label>
                <input id="whatsappCliente" formControlName="whatsappCliente" type="tel" placeholder="Ex: 21999998888">
              </div>
            </div>
          </fieldset>

          <fieldset class="form-group">
            <legend>Como você quer receber?</legend>
            <div class="radio-card-group">
              <label class="radio-card" [class.selected]="metodoEntrega?.value === 'Delivery'">
                <input type="radio" formControlName="metodoEntrega" value="Delivery">
                <i class="bi bi-truck"></i>
                <div class="radio-card-info">
                  <strong>Delivery</strong>
                  <span>Entrega em Bangu e região</span>
                </div>
              </label>
              <label class="radio-card" [class.selected]="metodoEntrega?.value === 'Retirar na Loja'">
                <input type="radio" formControlName="metodoEntrega" value="Retirar na Loja">
                <i class="bi bi-shop"></i>
                <div class="radio-card-info">
                  <strong>Retirar na Loja</strong>
                  <span>(Grátis)</span>
                </div>
              </label>
            </div>
          </fieldset>

          <!-- Campos de endereço aparecem só após CEP válido -->
          <div *ngIf="metodoEntrega?.value === 'Delivery'">
            <div class="form-group input-with-spinner">
              <label for="cep">CEP</label>
              <input #cepInput id="cep" formControlName="cep" type="text" placeholder="Digite o CEP">
              <div *ngIf="isCepLoading" class="spinner" role="status"></div>
            </div>

            <div *ngIf="isCepValid">
              <div class="form-grid">
                <div class="form-group two-thirds">
                  <label for="endereco">Rua</label>
                  <input id="endereco" formControlName="endereco" type="text" class="readonly-field">
                </div>
                <div class="form-group one-third">
                  <label for="numero">Número</label>
                  <input #numeroInput id="numero" formControlName="numero" type="text" placeholder="Ex: 123">
                </div>
                <div class="form-group half-width">
                  <label for="bairro">Bairro</label>
                  <input id="bairro" formControlName="bairro" type="text" class="readonly-field">
                </div>
                <div class="form-group half-width">
                  <label for="complemento">Complemento (Opcional)</label>
                  <input id="complemento" formControlName="complemento" type="text" placeholder="Ex: Apto 101">
                </div>
              </div>
            </div>
          </div>
        </form>
      </section>
    </div>

    <!-- Barra Lateral (Resumo do Pedido e Ações) -->
    <aside class="order-summary-section card">
      <header class="card-header">
        <h2><i class="bi bi-receipt-cutoff"></i> Resumo do Pedido</h2>
      </header>
      <div class="summary-details">
        <div class="summary-line">
          <span>Subtotal ({{ totalItens }} itens)</span>
          <span>{{ subtotal | currency:'BRL' }}</span>
        </div>
        <div class="summary-line" *ngIf="metodoEntrega?.value === 'Delivery'">
          <span>Frete</span>
          <span>{{ taxaEntrega | currency:'BRL' }}</span>
        </div>
        <div class="summary-line discount" *ngIf="desconto > 0">
          <span>Desconto</span>
          <span>-{{ desconto | currency:'BRL' }}</span>
        </div>
      </div>
      <div class="coupon-section">
        <label for="cupom">Cupom de Desconto</label>
        <div class="input-group">
          <input #cupomInput id="cupom" type="text" placeholder="Digite seu cupom">
          <button class="btn-apply-coupon" (click)="aplicarCupom(cupomInput.value)">Aplicar</button>
        </div>
      </div>
      <footer class="summary-footer">
        <div class="summary-total">
          <span>Total</span>
          <span>{{ total | currency:'BRL' }}</span>
        </div>
        <div class="final-actions">
          <button class="button-primary" form="checkout-main-form" type="submit" [disabled]="checkoutForm.invalid || cartItems.length === 0 || isSubmitting">
            <span *ngIf="!isSubmitting">Finalizar Pedido com Pix</span>
            <span *ngIf="isSubmitting" class="spinner-light"></span>
          </button>
          <button class="button-whatsapp" (click)="comprarPeloWhatsApp()">
            <i class="bi bi-whatsapp"></i> Comprar pelo WhatsApp
          </button>
        </div>
      </footer>
    </aside>
  </div>
</main>

<ng-template #emptyCart>
  <div class="empty-cart">
    <h2><i class="bi bi-cart-x"></i></h2>
    <p>O seu carrinho está vazio.</p>
    <a routerLink="/" class="button-secondary">Ver produtos</a>
  </div>
</ng-template>
